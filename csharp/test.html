<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>SqlSuger | Coder XX</title>
    <meta name="generator" content="VuePress 1.9.9">
    <link rel="stylesheet" href="styles/index.styl">
    <link rel="icon" href="favicon.ico">
    <meta name="description" content="">
    
    <link rel="preload" href="/blog/assets/css/0.styles.cd12c23a.css" as="style"><link rel="preload" href="/blog/assets/js/app.65a534cf.js" as="script"><link rel="preload" href="/blog/assets/js/2.9b17f659.js" as="script"><link rel="preload" href="/blog/assets/js/11.21536efd.js" as="script"><link rel="prefetch" href="/blog/assets/js/10.b6e5bbc7.js"><link rel="prefetch" href="/blog/assets/js/12.f992f6db.js"><link rel="prefetch" href="/blog/assets/js/13.3553f0d1.js"><link rel="prefetch" href="/blog/assets/js/14.04d611c8.js"><link rel="prefetch" href="/blog/assets/js/15.20c1edb0.js"><link rel="prefetch" href="/blog/assets/js/3.14a7fb2e.js"><link rel="prefetch" href="/blog/assets/js/4.784db7c8.js"><link rel="prefetch" href="/blog/assets/js/5.082bf8bb.js"><link rel="prefetch" href="/blog/assets/js/6.5b8cc223.js"><link rel="prefetch" href="/blog/assets/js/7.0168c993.js"><link rel="prefetch" href="/blog/assets/js/8.061e2d81.js"><link rel="prefetch" href="/blog/assets/js/9.45cddbd3.js">
    <link rel="stylesheet" href="/blog/assets/css/0.styles.cd12c23a.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/blog/" class="home-link router-link-active"><!----> <span class="site-name">Coder XX</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/blog/" class="nav-link">
  首页
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="前端" class="dropdown-title"><span class="title">前端</span> <span class="arrow down"></span></button> <button type="button" aria-label="前端" class="mobile-dropdown-title"><span class="title">前端</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/blog/webfront/HTML.html" class="nav-link">
  HTML
</a></li><li class="dropdown-item"><!----> <a href="/blog/webfront/CSS.html" class="nav-link">
  CSS
</a></li><li class="dropdown-item"><!----> <a href="/blog/webfront/JavaScript.html" class="nav-link">
  JS
</a></li><li class="dropdown-item"><!----> <a href="/blog/webfront/jQuery.html" class="nav-link">
  jQuery
</a></li><li class="dropdown-item"><!----> <a href="/blog/webfront/layui.html" class="nav-link">
  layui
</a></li><li class="dropdown-item"><!----> <a href="/blog/webfront/vue.html" class="nav-link">
  Vue
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label=".NET" class="dropdown-title"><span class="title">.NET</span> <span class="arrow down"></span></button> <button type="button" aria-label=".NET" class="mobile-dropdown-title"><span class="title">.NET</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/blog/csharp/csharp.html" class="nav-link">
  C#
</a></li><li class="dropdown-item"><!----> <a href="/blog/csharp/test.html" aria-current="page" class="nav-link router-link-exact-active router-link-active">
  test
</a></li></ul></div></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/blog/" class="nav-link">
  首页
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="前端" class="dropdown-title"><span class="title">前端</span> <span class="arrow down"></span></button> <button type="button" aria-label="前端" class="mobile-dropdown-title"><span class="title">前端</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/blog/webfront/HTML.html" class="nav-link">
  HTML
</a></li><li class="dropdown-item"><!----> <a href="/blog/webfront/CSS.html" class="nav-link">
  CSS
</a></li><li class="dropdown-item"><!----> <a href="/blog/webfront/JavaScript.html" class="nav-link">
  JS
</a></li><li class="dropdown-item"><!----> <a href="/blog/webfront/jQuery.html" class="nav-link">
  jQuery
</a></li><li class="dropdown-item"><!----> <a href="/blog/webfront/layui.html" class="nav-link">
  layui
</a></li><li class="dropdown-item"><!----> <a href="/blog/webfront/vue.html" class="nav-link">
  Vue
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label=".NET" class="dropdown-title"><span class="title">.NET</span> <span class="arrow down"></span></button> <button type="button" aria-label=".NET" class="mobile-dropdown-title"><span class="title">.NET</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/blog/csharp/csharp.html" class="nav-link">
  C#
</a></li><li class="dropdown-item"><!----> <a href="/blog/csharp/test.html" aria-current="page" class="nav-link router-link-exact-active router-link-active">
  test
</a></li></ul></div></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>SqlSuger</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/blog/csharp/test.html#sqlsuger" class="sidebar-link">SqlSuger</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/csharp/test.html#实体" class="sidebar-link">实体</a></li></ul></li><li><a href="/blog/csharp/test.html#comet技术" class="sidebar-link">Comet技术</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/blog/csharp/test.html#socket" class="sidebar-link">Socket</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/blog/csharp/test.html#websocket" class="sidebar-link">WebSocket</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/blog/csharp/test.html#" class="sidebar-link">/csharp/test.html#</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/blog/csharp/test.html#singalr" class="sidebar-link">SingalR</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/blog/csharp/test.html#sqldependency-signalr实现数据即时更新" class="sidebar-link">SqlDependency+SignalR实现数据即时更新</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/blog/csharp/test.html#jwt-json-web-token" class="sidebar-link">JWT(Json Web Token)</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/csharp/test.html#jwt的结构" class="sidebar-link">JWT的结构</a></li><li class="sidebar-sub-header"><a href="/blog/csharp/test.html#使用" class="sidebar-link">使用</a></li></ul></li><li><a href="/blog/csharp/test.html#单一职责-single-responsibility-principle" class="sidebar-link">单一职责（Single Responsibility Principle）</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/blog/csharp/test.html#开闭原则-open-closed-principle" class="sidebar-link">开闭原则（open closed principle）</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/blog/csharp/test.html#里氏替换" class="sidebar-link">里氏替换</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/blog/csharp/test.html#迪米特法则" class="sidebar-link">迪米特法则</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/blog/csharp/test.html#接口隔离" class="sidebar-link">接口隔离</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/blog/csharp/test.html#依赖倒置dependence-inversion-principle" class="sidebar-link">依赖倒置Dependence Inversion Principle</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/blog/csharp/test.html#公共响应参数" class="sidebar-link">公共响应参数</a><ul class="sidebar-sub-headers"></ul></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h2 id="sqlsuger"><a href="#sqlsuger" class="header-anchor">#</a> SqlSuger</h2> <p>文档：https://www.donet5.com/home/doc</p> <blockquote><p>使用</p></blockquote> <p>步骤一：安装SqlSugar（安装数据库的包如：使用MySQL则安装MySQL.Data）</p> <p>步骤二：创建实体</p> <p>步骤三：创建db对象</p> <div class="language-csharp extra-class"><pre class="language-csharp"><code><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">SqlSugarHelper</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">SqlSugarScope</span> Db <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">SqlSugarScope</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token constructor-invocation class-name">ConnectionConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            ConnectionString <span class="token operator">=</span> ConfigurationManager<span class="token punctuation">.</span>ConnectionStrings<span class="token punctuation">[</span><span class="token string">&quot;mysql&quot;</span><span class="token punctuation">]</span><span class="token punctuation">.</span>ConnectionString<span class="token punctuation">,</span><span class="token comment">//连接符字串</span>
            DbType <span class="token operator">=</span> DbType<span class="token punctuation">.</span>MySql<span class="token punctuation">,</span><span class="token comment">//数据库类型</span>
            IsAutoCloseConnection <span class="token operator">=</span> <span class="token boolean">true</span> <span class="token comment">//不设成true要手动close</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
          db <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
              <span class="token comment">//(A)全局生效配置点，一般AOP和程序启动的配置扔这里面 ，所有上下文生效</span>
              <span class="token comment">//调试SQL事件，可以删掉</span>
              db<span class="token punctuation">.</span>Aop<span class="token punctuation">.</span>OnLogExecuting <span class="token operator">=</span> <span class="token punctuation">(</span>sql<span class="token punctuation">,</span> pars<span class="token punctuation">)</span> <span class="token operator">=&gt;</span>
              <span class="token punctuation">{</span>
                  Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span>sql<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//输出sql,查看执行sql 性能无影响</span>

                  <span class="token comment">//获取原生SQL推荐 5.1.4.63  性能OK</span>
                  <span class="token comment">//UtilMethods.GetNativeSql(sql,pars)</span>

                  <span class="token comment">//获取无参数化SQL 对性能有影响，特别大的SQL参数多的，调试使用</span>
                  <span class="token comment">//UtilMethods.GetSqlString(DbType.SqlServer,sql,pars)</span>

              <span class="token punctuation">}</span><span class="token punctuation">;</span>

              <span class="token comment">//多个配置就写下面</span>
              <span class="token comment">//db.Ado.IsDisableMasterSlaveSeparation=true;</span>

              <span class="token comment">//注意多租户 有几个设置几个</span>
              <span class="token comment">//db.GetConnection(i).Aop</span>
          <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre></div><h3 id="实体"><a href="#实体" class="header-anchor">#</a> 实体</h3> <p>[SugarColumn(IsIgnore =true)]	不处理该字段，可用于VO查询时该列不在该表中</p> <h2 id="comet技术"><a href="#comet技术" class="header-anchor">#</a> Comet技术</h2> <p>Ajax轮询：每经过一段时间，就发起一次ajax请求。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token function">setInterval</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    $<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token number">3000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>优点：保证数据的即使更新。</p> <p>缺点：造成无效的请求。</p> <p><strong>Coment技术</strong></p> <p><strong>概念</strong>：Comet是一种用于web的技术，能使服务器能实时地将更新的信息传送到客户端，而无须客户端发出请求，目前有两种实现方式，长<a href="https://so.csdn.net/so/search?q=%E8%BD%AE%E8%AF%A2&amp;spm=1001.2101.3001.7020" target="_blank" rel="noopener noreferrer">轮询<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>和iframe流。</p> <p>简单的说是一种基于现有Http协议基础上的长轮询技术，之所有会产生这种技术的主要原因是Http协议是无状态的所以客户端和服务端之间没办法建立起一套长时间的连接。比如我们要做一个聊天室，在Web环境下我们通常不能从服务端推送消息到浏览器里，而只能通过每个客户端不断的轮询服务器，以获取最新的消息，这样一来效率非常低，而且不断的向服务器发送请求对于访问量大的应用来说也会造成很大的资源占用。</p> <p>于是人们就发现了这种技术，向服务器发起一个请求，然后服务器一直不响应这个请求，这样客户端和服务端之间就形成了一个长连接，直到服务端响应这个请求后结束本次连接。借用一下IBM里的图片：</p> <p><img src="https://img-blog.csdn.net/20151213154207268" alt="这里写图片描述"></p> <p>通过Ajax技术可以实现长轮询的服务器推模型，客户端和服务端之间通过不断的发起长轮询即可以实现数据的交互，这个过程由于是Ajax实现的异步操作所以体验上会比较好，效率也很高。哎呀呀，说不清楚，找个网上的资料：</p> <p>Comet方式通俗的说就是一种长连接机制(long lived http)。同样是由Browser端主动发起请求，但是Server端以一种似乎非常慢的响应方式给出回答。这样在这个期间内，服务器端可以使用同一个connection把要更新的数据主动发送给Browser。因此请求可能等待较长的时间，期间没有任何数据返回，但是一旦有了新的数据，它将立即被发送到客户机。Comet又有很多种实现方式，但是总的来说对Server端的负载都会有增加.虽然对于单位操作来说，每次只需要建议一次connection,但是由于connection是保持较长时间的,对于 server端的资源的占用要有所增加。</p> <p>优点： 实时性好（消息延时小）；性能好（能支持大量用户）</p> <p>缺点： 长期占用连接，丧失了无状态高并发的特点。</p> <p>应用： 股票系统、实时通讯。</p> <blockquote><p>使用：通过长连接查询支付状态</p></blockquote> <p><code>长连接接口</code></p> <div class="language-csharp extra-class"><pre class="language-csharp"><code><span class="token keyword">public</span> <span class="token return-type class-name">JsonResult</span> <span class="token function">validPay</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">int</span></span> id<span class="token punctuation">,</span><span class="token class-name"><span class="token keyword">int</span></span> SendTime<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token comment">//计算超时时间</span>
    <span class="token class-name"><span class="token keyword">int</span></span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        System<span class="token punctuation">.</span>Threading<span class="token punctuation">.</span>Thread<span class="token punctuation">.</span><span class="token function">Sleep</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        i<span class="token operator">++</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>i<span class="token operator">&lt;</span> SendTime<span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">GoChecked</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">{</span>
                <span class="token keyword">return</span> <span class="token function">Json</span><span class="token punctuation">(</span><span class="token string">&quot;true&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>i <span class="token operator">==</span> SendTime<span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token function">Json</span><span class="token punctuation">(</span><span class="token string">&quot;false&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">//判断支付状态</span>
<span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">bool</span></span> <span class="token function">GoChecked</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">int</span></span> id<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token class-name">Contract</span> contract <span class="token operator">=</span> _contractService<span class="token punctuation">.</span><span class="token function">GetNoChche</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>contract<span class="token punctuation">.</span>pay_status <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p><code>前端</code></p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">//轮询查询支付状态</span>
<span class="token keyword">function</span> <span class="token function">SendXHR</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    $<span class="token punctuation">.</span><span class="token function">ajax</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">&quot;post&quot;</span><span class="token punctuation">,</span>
        <span class="token literal-property property">url</span><span class="token operator">:</span> <span class="token string">&quot;/AliPay/validPay/@ViewBag.id&quot;</span><span class="token punctuation">,</span>
        <span class="token literal-property property">cache</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
        <span class="token literal-property property">timeout</span><span class="token operator">:</span> <span class="token number">1000</span> <span class="token operator">*</span> <span class="token number">60</span><span class="token punctuation">,</span>
        <span class="token literal-property property">data</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token literal-property property">SendTime</span><span class="token operator">:</span> <span class="token number">60</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token function-variable function">success</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">data<span class="token punctuation">,</span> textStatus</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            layer<span class="token punctuation">.</span><span class="token function">msg</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//刷新父页面</span>
            parent<span class="token punctuation">.</span>table<span class="token punctuation">.</span><span class="token function">reload</span><span class="token punctuation">(</span><span class="token string">&quot;tb&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//关闭弹出层</span>
            <span class="token keyword">var</span> index <span class="token operator">=</span> parent<span class="token punctuation">.</span>layer<span class="token punctuation">.</span><span class="token function">getFrameIndex</span><span class="token punctuation">(</span>window<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//从父页面上把layer关闭</span>
            parent<span class="token punctuation">.</span>layer<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token function-variable function">error</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">XMLHttpRequest<span class="token punctuation">,</span> textStatus<span class="token punctuation">,</span> errorThrown</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>textStatus <span class="token operator">==</span> <span class="token string">&quot;timeout&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">//超时间重发</span>
                <span class="token function">SendXHR</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="socket"><a href="#socket" class="header-anchor">#</a> Socket</h2> <p>基于C/S架构</p> <p>服务器端：</p> <p>第一步：创建一个用于监听连接的Socket对像；</p> <p>第二步：用指定的端口号和服务器的ip建立一个EndPoint对像； 127.0.0.1:5000用于监听</p> <p>第三步：用socket对像的Bind()方法绑定EndPoint；</p> <p>第四步：用socket对像的Listen()方法开始监听；</p> <p>第五步：接收到客户端的连接，用socket对像的Accept()方法创建一个新的用于和客户端进行通信的socket对像;</p> <p>第六步：通信结束后一定记得关闭socket;</p> <p>客户端：</p> <p>第一步：建立一个Socket对像；</p> <p>第二步：用指定的端口号和服务器的ip建立一个EndPoint对像；</p> <p>第三步：用socket对像的Connect()方法以上面建立的EndPoint对像做为参数，向服务器发出连接请求；</p> <p>第四步：如果连接成功，就用socket对像的Send()方法向服务器发送信息；</p> <p>第五步：用socket对像的Receive()方法接受服务器发来的信息 ;</p> <p>第六步：通信结束后一定记得关闭socket；</p> <h2 id="websocket"><a href="#websocket" class="header-anchor">#</a> WebSocket</h2> <p><strong>HTML5 WebSocket</strong></p> <p>WebSocket 是 HTML5 开始提供的一种在单个 TCP 连接上进行全双工通讯的协议。</p> <p>WebSocket 使得客户端和服务器之间的数据交换变得更加简单，允许服务端主动向客户端推送数据。在 WebSocket API 中，浏览器和服务器只需要完成一次握手，两者之间就直接可以创建持久性的连接，并进行双向数据传输。</p> <p>在 WebSocket API 中，浏览器和服务器只需要做一个握手的动作，然后，浏览器和服务器之间就形成了一条快速通道。两者之间就直接可以数据互相传送。</p> <p>现在，很多网站为了实现推送技术，所用的j技术都是 Ajax 轮询。轮询是在特定的的时间间隔（如每1秒），由浏览器对服务器发出HTTP请求，然后由服务器返回最新的数据给客户端的浏览器。这种传统的模式带来很明显的缺点，即浏览器需要不断的向服务器发出请求，然而HTTP请求可能包含较长的头部，其中真正有效的数据可能只是很小的一部分，显然这样会浪费很多的带宽等资源。</p> <p>HTML5 定义的 WebSocket 协议，能更好的节省服务器资源和带宽，并且能够更实时地进行通讯。</p> <p><img src="https://www.runoob.com/wp-content/uploads/2016/03/ws.png" alt="img"></p> <p>浏览器通过 JavaScript 向服务器发出建立 WebSocket 连接的请求，连接建立以后，客户端和服务器端就可以通过 TCP 连接直接交换数据。</p> <p>当你获取 Web Socket 连接后，你可以通过 <strong>send()</strong> 方法来向服务器发送数据，并通过 <strong>onmessage</strong> 事件来接收服务器返回的数据。</p> <p>以下 API 用于创建 WebSocket 对象。</p> <div class="language-csharp extra-class"><pre class="language-csharp"><code><span class="token class-name"><span class="token keyword">var</span></span> Socket <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">WebSocket</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">protocol</span></span><span class="token punctuation">]</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>

</code></pre></div><p>以上代码中的第一个参数 url, 指定连接的 URL。第二个参数 protocol 是可选的，指定了可接受的子协议。</p> <hr> <p><strong>WebSocket 属性</strong></p> <p>以下是 WebSocket 对象的属性。假定我们使用了以上代码创建了 Socket 对象：</p> <table><thead><tr><th style="text-align:left;">属性</th> <th style="text-align:left;">描述</th></tr></thead> <tbody><tr><td style="text-align:left;">Socket.readyState</td> <td style="text-align:left;">只读属性 <strong>readyState</strong> 表示连接状态，可以是以下值：0 - 表示连接尚未建立。1 - 表示连接已建立，可以进行通信。2 - 表示连接正在进行关闭。3 - 表示连接已经关闭或者连接不能打开。</td></tr> <tr><td style="text-align:left;">Socket.bufferedAmount</td> <td style="text-align:left;">只读属性 <strong>bufferedAmount</strong> 已被 send() 放入正在队列中等待传输，但是还没有发出的 UTF-8 文本字节数。</td></tr></tbody></table> <hr> <p><strong>WebSocket 事件</strong></p> <p>以下是 WebSocket 对象的相关事件。假定我们使用了以上代码创建了 Socket 对象：</p> <table><thead><tr><th style="text-align:left;">事件</th> <th style="text-align:left;">事件处理程序</th> <th style="text-align:left;">描述</th></tr></thead> <tbody><tr><td style="text-align:left;">message</td> <td style="text-align:left;">Socket.onmessage</td> <td style="text-align:left;">客户端接收服务端数据时触发</td></tr> <tr><td style="text-align:left;">error</td> <td style="text-align:left;">Socket.onerror</td> <td style="text-align:left;">通信发生错误时触发</td></tr> <tr><td style="text-align:left;">open</td> <td style="text-align:left;">Socket.onopen</td> <td style="text-align:left;">连接建立时触发</td></tr> <tr><td style="text-align:left;">close</td> <td style="text-align:left;">Socket.onclose</td> <td style="text-align:left;">连接关闭时触发</td></tr></tbody></table> <hr> <p><strong>WebSocket 方法</strong></p> <p>以下是 WebSocket 对象的相关方法。假定我们使用了以上代码创建了 Socket 对象：</p> <table><thead><tr><th style="text-align:left;">方法</th> <th style="text-align:left;">描述</th></tr></thead> <tbody><tr><td style="text-align:left;">Socket.send()</td> <td style="text-align:left;">使用连接发送数据</td></tr> <tr><td style="text-align:left;">Socket.close()</td> <td style="text-align:left;">关闭连接</td></tr></tbody></table> <p><strong>ASP.NET下的socket实现</strong></p> <p>发送推送消息</p> <div class="language-csharp extra-class"><pre class="language-csharp"><code><span class="token class-name">ArraySegment<span class="token punctuation">&lt;</span><span class="token keyword">byte</span><span class="token punctuation">&gt;</span></span> buffer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">ArraySegment<span class="token punctuation">&lt;</span><span class="token keyword">byte</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token constructor-invocation class-name"><span class="token keyword">byte</span></span><span class="token punctuation">[</span><span class="token number">2048</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
buffer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">ArraySegment<span class="token punctuation">&lt;</span><span class="token keyword">byte</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>Encoding<span class="token punctuation">.</span>UTF8<span class="token punctuation">.</span><span class="token function">GetBytes</span><span class="token punctuation">(</span>content<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//登录提醒（包括自己）</span>
<span class="token keyword">foreach</span> <span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">var</span></span> socket <span class="token keyword">in</span> _UserDictionary<span class="token punctuation">.</span><span class="token function">Select</span><span class="token punctuation">(</span>d <span class="token operator">=&gt;</span> d<span class="token punctuation">.</span>Value<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">await</span> socket<span class="token punctuation">.</span><span class="token function">SendAsync</span><span class="token punctuation">(</span>buffer<span class="token punctuation">,</span> WebSocketMessageType<span class="token punctuation">.</span>Text<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> cancellationToken<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>服务端接收指令</p> <div class="language-csharp extra-class"><pre class="language-csharp"><code><span class="token class-name">ArraySegment<span class="token punctuation">&lt;</span><span class="token keyword">byte</span><span class="token punctuation">&gt;</span></span> buffer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">ArraySegment<span class="token punctuation">&lt;</span><span class="token keyword">byte</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token constructor-invocation class-name"><span class="token keyword">byte</span></span><span class="token punctuation">[</span><span class="token number">2048</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//接受指令</span>
<span class="token class-name">WebSocketReceiveResult</span> result <span class="token operator">=</span> <span class="token keyword">await</span> socket<span class="token punctuation">.</span><span class="token function">ReceiveAsync</span><span class="token punctuation">(</span>buffer<span class="token punctuation">,</span> cancellationToken<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//表示是关闭指令</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>result<span class="token punctuation">.</span>MessageType <span class="token operator">==</span> WebSocketMessageType<span class="token punctuation">.</span>Close<span class="token punctuation">)</span>
<span class="token punctuation">{</span>	<span class="token comment">//断开指令</span>
    <span class="token keyword">await</span> socket<span class="token punctuation">.</span><span class="token function">CloseAsync</span><span class="token punctuation">(</span>WebSocketCloseStatus<span class="token punctuation">.</span>NormalClosure<span class="token punctuation">,</span> String<span class="token punctuation">.</span>Empty<span class="token punctuation">,</span> cancellationToken<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">else</span>
<span class="token punctuation">{</span>
    <span class="token comment">//获取客户端发送内容</span>
    <span class="token class-name"><span class="token keyword">string</span></span> userMsg <span class="token operator">=</span> Encoding<span class="token punctuation">.</span>UTF8<span class="token punctuation">.</span><span class="token function">GetString</span><span class="token punctuation">(</span>buffer<span class="token punctuation">.</span>Array<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> result<span class="token punctuation">.</span>Count<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id=""><a href="#" class="header-anchor">#</a></h2> <h2 id="singalr"><a href="#singalr" class="header-anchor">#</a> SingalR</h2> <p>https://docs.microsoft.com/zh-cn/aspnet/signalr/</p> <p>ASP .NET SignalR是一个ASP .NET 下的类库，可以在ASP .NET 的Web项目中实现实时通信.</p> <p><img src="https://images0.cnblogs.com/blog/15172/201412/061436271702087.png" alt="image"></p> <p>Asp.net SignalR 2 实现 服务端消息推送到Web端, 更加简单. 为了获取更好的可伸缩性, 我们引入消息队列, 看如下基本流程图:</p> <p><a href="https://images0.cnblogs.com/blog/15172/201412/061436278897701.png" target="_blank" rel="noopener noreferrer"><img src="https://images0.cnblogs.com/blog/15172/201412/061436285762559.png" alt="image"><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <blockquote><p>使用</p></blockquote> <p><strong>步骤一：安装包</strong></p> <div class="language-shell extra-class"><pre class="language-shell"><code>Install-Package Microsoft.AspNet.SignalR

</code></pre></div><p><strong>步骤二：更新jquery</strong></p> <div class="language-shell extra-class"><pre class="language-shell"><code>UPDATE-Package Microsoft.AspNet.SignalR <span class="token parameter variable">-Version</span> <span class="token number">2.4</span>.0
UPDATE-Package jQuery <span class="token parameter variable">-Version</span> <span class="token number">1.8</span>.2

</code></pre></div><p><strong>步骤三：创建一个集线器</strong></p> <div class="language-csharp extra-class"><pre class="language-csharp"><code><span class="token keyword">using</span> <span class="token namespace">Microsoft<span class="token punctuation">.</span>AspNet<span class="token punctuation">.</span>SignalR</span><span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token namespace">Microsoft<span class="token punctuation">.</span>AspNet<span class="token punctuation">.</span>SignalR<span class="token punctuation">.</span>Hubs</span><span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token namespace">System</span><span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token namespace">System<span class="token punctuation">.</span>Collections<span class="token punctuation">.</span>Generic</span><span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token namespace">System<span class="token punctuation">.</span>Linq</span><span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token namespace">System<span class="token punctuation">.</span>Web</span><span class="token punctuation">;</span>

<span class="token keyword">namespace</span> <span class="token namespace">Singalr<span class="token punctuation">.</span>Hubs</span>
<span class="token punctuation">{</span>
    <span class="token comment">/// &lt;summary&gt;</span>
    <span class="token comment">/// 自定义SignalR集线器代理类名称</span>
    <span class="token comment">/// &lt;/summary&gt;</span>
    <span class="token punctuation">[</span><span class="token function">HubName</span><span class="token punctuation">(</span><span class="token string">&quot;myChatHub&quot;</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
    <span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MyChatHub</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">Hub</span></span>
    <span class="token punctuation">{</span>
        <span class="token comment">/// &lt;summary&gt;</span>
        <span class="token comment">/// 推送至所有客户端</span>
        <span class="token comment">/// &lt;/summary&gt;</span>
        <span class="token comment">/// &lt;param name=&quot;message&quot;&gt;消息&lt;/param&gt;</span>
        <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">Send</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">string</span></span> message<span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token comment">//调用所有客户端的SendMessage方法</span>
            Clients<span class="token punctuation">.</span>All<span class="token punctuation">.</span><span class="token function">SendMessage</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre></div><p><strong>步骤四：前端代码</strong></p> <div class="language-html extra-class"><pre class="language-html"><code><span class="token doctype"><span class="token punctuation">&lt;!</span><span class="token doctype-tag">DOCTYPE</span> <span class="token name">html</span><span class="token punctuation">&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span> <span class="token attr-name">xmlns</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>http://www.w3.org/1999/xhtml<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span> <span class="token attr-name">runat</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>server<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">http-equiv</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>Content-Type<span class="token punctuation">&quot;</span></span> <span class="token attr-name">content</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>text/html; charset=utf-8<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>title</span><span class="token punctuation">&gt;</span></span>SignalR实时消息推送到客户端<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>title</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>Scripts/jquery-1.8.2.js<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
    <span class="token comment">&lt;!--引用SignalR库--&gt;</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>Scripts/jquery.signalR-2.1.2.min.js<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
    <span class="token comment">&lt;!--引用自动生成的SignalR集线器(Hub)脚本.在运行的时候在浏览器的Source下可看到--&gt;</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>/signalr/hubs<span class="token punctuation">&quot;</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>text/javascript<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>text/javascript<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
        <span class="token function">$</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">//引用服务端的集线器代理类       </span>
            <span class="token keyword">var</span> chat <span class="token operator">=</span> $<span class="token punctuation">.</span>connection<span class="token punctuation">.</span>myChatHub<span class="token punctuation">;</span>
            <span class="token comment">//定义服务器端调用的客户端SendMessage方法来显示新消息</span>
            chat<span class="token punctuation">.</span>client<span class="token punctuation">.</span><span class="token function-variable function">SendMessage</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">message</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                
                <span class="token function">ShowMessage</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token punctuation">;</span>

            <span class="token comment">//设置焦点到输入框</span>
            <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">'#message'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">focus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">//开始连接服务器</span>
            $<span class="token punctuation">.</span>connection<span class="token punctuation">.</span>hub<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">done</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">'#SendMessage'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">click</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment">//调用服务器端定义的Send方法</span>
                    chat<span class="token punctuation">.</span>server<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token function">$</span><span class="token punctuation">(</span><span class="token string">'#message'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">val</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment">//清空输入框信息并获取焦点</span>
                    <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">'#message'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">val</span><span class="token punctuation">(</span><span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">focus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//向页面添加消息</span>
        <span class="token keyword">function</span> <span class="token function">ShowMessage</span><span class="token punctuation">(</span><span class="token parameter">message</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                 
            <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">'#list'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">'&lt;li&gt;'</span> <span class="token operator">+</span> message <span class="token operator">+</span> <span class="token string">'&lt;/li&gt;'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>      
    </span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>head</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>form</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>form1<span class="token punctuation">&quot;</span></span> <span class="token attr-name">runat</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>server<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>text<span class="token punctuation">&quot;</span></span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>message<span class="token punctuation">&quot;</span></span> <span class="token punctuation">/&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>button<span class="token punctuation">&quot;</span></span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>SendMessage<span class="token punctuation">&quot;</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>发送<span class="token punctuation">&quot;</span></span> <span class="token punctuation">/&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ul</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>list<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>ul</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>form</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p><strong>步骤五：添加启动类StartUp</strong></p> <div class="language-csharp extra-class"><pre class="language-csharp"><code><span class="token keyword">using</span> <span class="token namespace">Microsoft<span class="token punctuation">.</span>Owin</span><span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token namespace">Owin</span><span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token namespace">System</span><span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token namespace">System<span class="token punctuation">.</span>Collections<span class="token punctuation">.</span>Generic</span><span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token namespace">System<span class="token punctuation">.</span>Linq</span><span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token namespace">System<span class="token punctuation">.</span>Web</span><span class="token punctuation">;</span>

<span class="token punctuation">[</span><span class="token attribute"><span class="token target keyword">assembly</span><span class="token punctuation">:</span> <span class="token class-name">OwinStartup</span><span class="token attribute-arguments"><span class="token punctuation">(</span><span class="token keyword">typeof</span><span class="token punctuation">(</span><span class="token type-expression class-name">Singalr<span class="token punctuation">.</span>App_Start<span class="token punctuation">.</span>Startup</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span></span><span class="token punctuation">]</span>
<span class="token keyword">namespace</span> <span class="token namespace">Singalr<span class="token punctuation">.</span>App_Start</span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Startup</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">Configuration</span><span class="token punctuation">(</span><span class="token class-name">IAppBuilder</span> app<span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token comment">// Any connection or hub wire up and configuration should go here</span>
            app<span class="token punctuation">.</span><span class="token function">MapSignalR</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>每一个使用的OWin组件的Web框架都需要一个StartUp入口类，用来声明OWin组件：</p> <ol><li>项目会自动扫描程序集根下的名为StartUp的类作为入口类</li> <li>通过添加 [assembly: OwinStartup(typeof(SignalRDEMO.Startup))] 标签标记入口类</li></ol> <p><strong>常用的推送方式</strong></p> <p>以下列出其他推送方式：</p> <ul><li><p>所有连接的客户端　　
Clients.All.show(content);</p></li> <li><p>仅调用的客户端
Clients.Caller.show(content);</p></li> <li><p>除调用客户端之外的所有客户端
Clients.Others.show(content);</p></li> <li><p>特定的客户端标识的连接 id
Clients.Client(Context.ConnectionId).show(content);</p></li> <li><p>所有连接的客户端除外指定客户端，由连接 ID 标识
Clients.AllExcept(connectionId1, connectionId2).show(content);</p></li> <li><p>指定组中的所有连接的客户端
Clients.Group(groupName).show(content);</p></li> <li><p>指定组中的所有连接的客户端除外指定客户端，由连接 ID 标识。
Clients.Group(groupName, connectionId1, connectionId2).show(content);</p></li> <li><p>所有连接的客户端指定组中除调用客户端
Clients.OthersInGroup(groupName).show(content);</p></li> <li><p>所有客户端和组列表中的连接 Id
Clients.Clients(ConnectionIds).show(content);</p></li> <li><p>组的列表。
Clients.Groups(GroupIds).show(content);</p></li> <li><p>按名称的用户
Clients.Client(username).show(content); //这里的username我还没理解是怎么创建的</p></li> <li><p>（在 SignalR 2.1 中引入） 的用户名称的列表。
Clients.Users(new string[] { &quot;myUser&quot;, &quot;myUser2&quot; }).show(content)</p></li></ul> <p><strong>关于ConnectionId</strong></p> <p>每个连接的页面都会产生不同的连接id，并且这个连接id是随机产生，不能自定义的</p> <p>集线器中为我们提供了Context对象可以获取到这个连接id</p> <div class="language-csharp extra-class"><pre class="language-csharp"><code><span class="token comment">/// &lt;summary&gt;</span>
<span class="token comment">/// 返回每个连接的id</span>
<span class="token comment">/// &lt;/summary&gt;</span>
<span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">ReturnConnectionId</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    Clients<span class="token punctuation">.</span>Caller<span class="token punctuation">.</span><span class="token function">show</span><span class="token punctuation">(</span>Context<span class="token punctuation">.</span>ConnectionId<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p><strong>服务端自身调用Hub进行广播推送</strong></p> <div class="language-csharp extra-class"><pre class="language-csharp"><code><span class="token class-name">IHubContext</span> chat <span class="token operator">=</span> GlobalHost<span class="token punctuation">.</span>ConnectionManager<span class="token punctuation">.</span><span class="token function">GetHubContext</span><span class="token punctuation">(</span><span class="token string">&quot;myChatHub&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h2 id="sqldependency-signalr实现数据即时更新"><a href="#sqldependency-signalr实现数据即时更新" class="header-anchor">#</a> SqlDependency+SignalR实现数据即时更新</h2> <p>应用：数据实时性较高的场景、新闻、监控数据等。</p> <blockquote><p>使用</p></blockquote> <p><strong>步骤一：sqlserver数据库启用监听服务，以便支持SqlDependency特性。</strong></p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token comment">--查询是否开启服务  0未开启 1开启</span>
<span class="token keyword">SELECT</span> is_broker_enabled <span class="token keyword">FROM</span> sys<span class="token punctuation">.</span><span class="token keyword">databases</span> <span class="token keyword">WHERE</span> name <span class="token operator">=</span> <span class="token string">'数据库名'</span>

<span class="token comment">--为某一数据库开启服务</span>
<span class="token keyword">ALTER</span> <span class="token keyword">DATABASE</span> 数据库名 <span class="token keyword">SET</span> NEW_BROKER <span class="token keyword">WITH</span> <span class="token keyword">ROLLBACK</span> IMMEDIATE<span class="token punctuation">;</span>
<span class="token keyword">ALTER</span> <span class="token keyword">DATABASE</span> 数据库名 <span class="token keyword">SET</span> ENABLE_BROKER<span class="token punctuation">;</span>
</code></pre></div><p><strong>步骤二：配置Signalr</strong></p> <p>App_Start中注册管道，将signalr注册到全局运行对象中</p> <p>创建集线器hub</p> <p><strong>步骤三：监听SQLDependency</strong></p> <div class="language-csharp extra-class"><pre class="language-csharp"><code><span class="token keyword">public</span> <span class="token return-type class-name">List<span class="token punctuation">&lt;</span>ChatUser<span class="token punctuation">&gt;</span></span> <span class="token function">GetData</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">using</span> <span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">var</span></span> sqlconnection <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">SqlConnection</span><span class="token punctuation">(</span>ConfigurationManager<span class="token punctuation">.</span>ConnectionStrings<span class="token punctuation">[</span><span class="token string">&quot;connString&quot;</span><span class="token punctuation">]</span><span class="token punctuation">.</span>ConnectionString<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>

        sqlconnection<span class="token punctuation">.</span><span class="token function">Open</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">using</span> <span class="token punctuation">(</span><span class="token class-name">SqlCommand</span> cmd <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">SqlCommand</span><span class="token punctuation">(</span><span class="token string">&quot;SELECT * FROM dbo.Chat_User&quot;</span><span class="token punctuation">,</span> sqlconnection<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            cmd<span class="token punctuation">.</span>Notification <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
            <span class="token class-name">SqlDependency</span> dependency <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">SqlDependency</span><span class="token punctuation">(</span>cmd<span class="token punctuation">)</span><span class="token punctuation">;</span>
            dependency<span class="token punctuation">.</span>OnChange <span class="token operator">+=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">OnChangeEventHandler</span><span class="token punctuation">(</span>dependency_Onchange<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>sqlconnection<span class="token punctuation">.</span>State <span class="token operator">==</span> ConnectionState<span class="token punctuation">.</span>Closed<span class="token punctuation">)</span>
                sqlconnection<span class="token punctuation">.</span><span class="token function">Open</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">SqlDataReader</span> reader <span class="token operator">=</span> cmd<span class="token punctuation">.</span><span class="token function">ExecuteReader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">List<span class="token punctuation">&lt;</span>ChatUser<span class="token punctuation">&gt;</span></span> list <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">List<span class="token punctuation">&lt;</span>ChatUser<span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">while</span> <span class="token punctuation">(</span>reader<span class="token punctuation">.</span><span class="token function">Read</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">{</span>
                <span class="token class-name">ChatUser</span> m <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">ChatUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                m<span class="token punctuation">.</span>id <span class="token operator">=</span> Convert<span class="token punctuation">.</span><span class="token function">ToInt32</span><span class="token punctuation">(</span>reader<span class="token punctuation">[</span><span class="token string">&quot;id&quot;</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                m<span class="token punctuation">.</span>account <span class="token operator">=</span> Convert<span class="token punctuation">.</span><span class="token function">ToString</span><span class="token punctuation">(</span>reader<span class="token punctuation">[</span><span class="token string">&quot;account&quot;</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                m<span class="token punctuation">.</span>img_url <span class="token operator">=</span> Convert<span class="token punctuation">.</span><span class="token function">ToString</span><span class="token punctuation">(</span>reader<span class="token punctuation">[</span><span class="token string">&quot;img_url&quot;</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                list<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span>m<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">return</span> list<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">dependency_Onchange</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">object</span></span> sender<span class="token punctuation">,</span> <span class="token class-name">SqlNotificationEventArgs</span> e<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>e<span class="token punctuation">.</span>Type <span class="token operator">==</span> SqlNotificationType<span class="token punctuation">.</span>Change<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token class-name">IHubContext</span> context <span class="token operator">=</span> GlobalHost<span class="token punctuation">.</span>ConnectionManager<span class="token punctuation">.</span><span class="token function">GetHubContext</span><span class="token punctuation">(</span><span class="token string">&quot;chatUserHub&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        context<span class="token punctuation">.</span>Clients<span class="token punctuation">.</span>All<span class="token punctuation">.</span><span class="token function">SendData</span><span class="token punctuation">(</span><span class="token function">GetData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>

</code></pre></div><p><strong>步骤四：在global中注册SQLDependency启动项</strong></p> <p><code>Global.asax.cs</code></p> <div class="language-csharp extra-class"><pre class="language-csharp"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MvcApplication</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">System<span class="token punctuation">.</span>Web<span class="token punctuation">.</span>HttpApplication</span></span>
<span class="token punctuation">{</span>
    <span class="token keyword">protected</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">Application_Start</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        AreaRegistration<span class="token punctuation">.</span><span class="token function">RegisterAllAreas</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        RouteConfig<span class="token punctuation">.</span><span class="token function">RegisterRoutes</span><span class="token punctuation">(</span>RouteTable<span class="token punctuation">.</span>Routes<span class="token punctuation">)</span><span class="token punctuation">;</span>
        SqlDependency<span class="token punctuation">.</span><span class="token function">Start</span><span class="token punctuation">(</span>ConfigurationManager<span class="token punctuation">.</span>ConnectionStrings<span class="token punctuation">[</span><span class="token string">&quot;connString&quot;</span><span class="token punctuation">]</span><span class="token punctuation">.</span>ConnectionString<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">protected</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">Application_End</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">object</span></span> sender<span class="token punctuation">,</span> <span class="token class-name">EventArgs</span> e<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token comment">//当被监测的数据库中的数据发生变化时,SqlDependency会自动触发OnChange事件来通知应用程序,从而达到让系统自动更新数据(或缓存)的目的。</span>
        SqlDependency<span class="token punctuation">.</span><span class="token function">Stop</span><span class="token punctuation">(</span>ConfigurationManager<span class="token punctuation">.</span>ConnectionStrings<span class="token punctuation">[</span><span class="token string">&quot;connString&quot;</span><span class="token punctuation">]</span><span class="token punctuation">.</span>ConnectionString<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre></div><p><strong>步骤五：前台调用加载</strong></p> <div class="language-html extra-class"><pre class="language-html"><code><span class="token doctype"><span class="token punctuation">&lt;!</span><span class="token doctype-tag">DOCTYPE</span> <span class="token name">html</span><span class="token punctuation">&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>viewport<span class="token punctuation">&quot;</span></span> <span class="token attr-name">content</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>width=device-width<span class="token punctuation">&quot;</span></span> <span class="token punctuation">/&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>title</span><span class="token punctuation">&gt;</span></span>Index<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>title</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>~/Scripts/jquery-1.8.2.min.js<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>~/Scripts/jquery.signalR-2.4.3.min.js<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>/signalr/hubs<span class="token punctuation">&quot;</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>text/javascript<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
        <span class="token function">$</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">var</span> chat <span class="token operator">=</span> $<span class="token punctuation">.</span>connection<span class="token punctuation">.</span>chatUserHub<span class="token punctuation">;</span>
            <span class="token comment">//定义客户端的javascript</span>
            chat<span class="token punctuation">.</span>client<span class="token punctuation">.</span><span class="token function-variable function">sendData</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">userList</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>userList<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            $<span class="token punctuation">.</span>connection<span class="token punctuation">.</span>hub<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">done</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                chat<span class="token punctuation">.</span>server<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    </span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>head</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">&gt;</span></span>
    
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">&gt;</span></span>

</code></pre></div><p><em><em>注意：监听SQLDependency时，监视的字段必须一一指定，不能写</em>，也不能用group by</em>*</p> <h2 id="jwt-json-web-token"><a href="#jwt-json-web-token" class="header-anchor">#</a> JWT(Json Web Token)</h2> <p>是一种用于双方之间传递安全信息的简洁的、URL安全的表述性声明规范。JWT作为一个开放的标准（ RFC 7519 ），定义了一种简洁的，自包含的方法用于通信双方之间以Json对象的形式安全的传递信息。因为数字签名的存在，这些信息是可信的，JWT可以使用HMAC算法或者是RSA的公私秘钥对进行签名。</p> <h3 id="jwt的结构"><a href="#jwt的结构" class="header-anchor">#</a> <strong>JWT的结构</strong></h3> <p>JWT一般由三段构成，用.号分隔开，第一段是header，第二段是payload，第三段是signature，例如：</p> <div class="language-csharp extra-class"><pre class="language-csharp"><code>eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9<span class="token punctuation">.</span>eyJuYW1lIjoiTXJCdWciLCJleHAiOjE1MTI5NTkzMDMuMCwianRpIjoibHVvemhpcGVuZyJ9<span class="token punctuation">.</span>9iwGMHmS0mophyFgliLK15hs_eE770IchaZ<span class="token operator">-</span>bWcX5c0

</code></pre></div><p><strong>1.header</strong></p> <p>jwt的头部承载两部分信息：</p> <p>声明类型。这里是JWT。</p> <p>声明加密的算法。通常直接使用 HMAC SHA256，其它还有RS256等。</p> <div class="language-json extra-class"><pre class="language-json"><code><span class="token punctuation">{</span><span class="token property">&quot;alg&quot;</span><span class="token operator">:</span> <span class="token string">&quot;HS256&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;typ&quot;</span><span class="token operator">:</span> <span class="token string">&quot;JWT&quot;</span><span class="token punctuation">}</span>

</code></pre></div><p>然后将头部进行base64加密（该加密是可以对称解密的),构成了第一部分</p> <div class="language-csharp extra-class"><pre class="language-csharp"><code>eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9

</code></pre></div><p><strong>2.payload</strong></p> <p>载荷就是存放有效信息的地方。这些有效信息包含三个部分：<strong>标准中注册的声明</strong>、公共的声明、私有的声明</p> <p><strong>标准中注册的声明 (建议但不强制使用) ：</strong></p> <p>iss ： jwt签发者</p> <p>sub：jwt所面向的用户</p> <p>aud：接收jwt的一方</p> <p>exp：jwt的过期时间，这个过期时间必须要大于签发时间</p> <p>nbf：定义在什么时间之前，该jwt都是不可用的.</p> <p>iat ：jwt的签发时间</p> <p>jti ：jwt的唯一身份标识，主要用来作为一次性token,从而回避重放攻击。</p> <p><strong>公共的声明 ：</strong></p> <p>公共的声明可以添加任何的信息，一般添加用户的相关信息或其他业务需要的必要信息.但不建议添加敏感信息，因为该部分在客户端可解密。</p> <p><strong>私有的声明 ：</strong></p> <p>私有声明是提供者和消费者所共同定义的声明，一般不建议存放敏感信息，因为base64是对称解密的，意味着该部分信息可以归类为明文信息。</p> <p>定义一个playload</p> <div class="language-json extra-class"><pre class="language-json"><code><span class="token punctuation">{</span> <span class="token property">&quot;name&quot;</span><span class="token operator">:</span> <span class="token string">&quot;MrBug&quot;</span><span class="token punctuation">,</span> <span class="token property">&quot;exp&quot;</span><span class="token operator">:</span> <span class="token number">1512959303</span><span class="token punctuation">,</span> <span class="token property">&quot;jti&quot;</span><span class="token operator">:</span> <span class="token string">&quot;admin&quot;</span><span class="token punctuation">}</span>

</code></pre></div><p>然后将其进行base64加密，得到Jwt的第二部分</p> <div class="language-csharp extra-class"><pre class="language-csharp"><code>eyJuYW1lIjoiTXJCdWciLCJleHAiOjE1MTI5NTkzMDMuMCwianRpIjoibHVvemhpcGVuZyJ9

</code></pre></div><p><strong>3.signature</strong></p> <p>jwt的第三部分是一个签证信息，这个签证信息由三部分组成：header (base64后的)、payload (base64后的)、<strong>secret</strong></p> <p>这个部分需要base64加密后的header和base64加密后的payload使用.连接组成的字符串，然后通过header中声明的加密方式进行加secret组合加密，然后就构成了jwt的第三部分。</p> <div class="language-csharp extra-class"><pre class="language-csharp"><code>9iwGMHmS0mophyFgliLK15hs_eE770IchaZ<span class="token operator">-</span>bWcX5c0

</code></pre></div><p>注意：secret是保存在服务器端的，jwt的签发生成也是在服务器端的，secret就是用来进行jwt的签发和jwt的验证，所以，它就是你服务端的私钥，在任何场景都不应该流露出去。一旦客户端得知这个secret, 那就意味着客户端是可以自我签发jwt了。</p> <h3 id="使用"><a href="#使用" class="header-anchor">#</a> 使用</h3> <p><strong>安装JWT包、JWTBearer包</strong></p> <blockquote><p>方式一：声明一个帮助类来完成token的生成和验证</p></blockquote> <div class="language-csharp extra-class"><pre class="language-csharp"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TokenHelper</span>
<span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token class-name"><span class="token keyword">string</span></span> secretKey <span class="token operator">=</span> <span class="token string">&quot;AnDeLiYa&quot;</span><span class="token punctuation">;</span><span class="token comment">//口令加密秘钥</span>
    <span class="token comment">/// &lt;summary&gt;</span>
    <span class="token comment">/// token加密</span>
    <span class="token comment">/// &lt;/summary&gt;</span>
    <span class="token comment">/// &lt;param name=&quot;userName&quot;&gt;&lt;/param&gt;</span>
    <span class="token comment">/// &lt;returns&gt;&lt;/returns&gt;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token return-type class-name"><span class="token keyword">string</span></span> <span class="token function">GenerateToken</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">string</span></span> userName<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token class-name"><span class="token keyword">var</span></span> tokenHandler <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">JwtSecurityTokenHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 扩展密钥大小为 128 位（32 字节）</span>
        <span class="token class-name"><span class="token keyword">var</span></span> key <span class="token operator">=</span> Encoding<span class="token punctuation">.</span>ASCII<span class="token punctuation">.</span><span class="token function">GetBytes</span><span class="token punctuation">(</span>secretKey<span class="token punctuation">.</span><span class="token function">PadRight</span><span class="token punctuation">(</span><span class="token number">32</span><span class="token punctuation">,</span> <span class="token char">'\0'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
        <span class="token class-name"><span class="token keyword">var</span></span> tokenDescriptor <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">SecurityTokenDescriptor</span>
        <span class="token punctuation">{</span>
            Subject <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">ClaimsIdentity</span><span class="token punctuation">(</span><span class="token keyword">new</span><span class="token punctuation">[</span><span class="token punctuation">]</span>
            <span class="token punctuation">{</span>
            	<span class="token keyword">new</span> <span class="token constructor-invocation class-name">Claim</span><span class="token punctuation">(</span><span class="token string">&quot;customClaim&quot;</span><span class="token punctuation">,</span> userName<span class="token punctuation">)</span>  <span class="token comment">// 设置其他声明</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            Expires <span class="token operator">=</span> DateTime<span class="token punctuation">.</span>UtcNow<span class="token punctuation">.</span><span class="token function">AddHours</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token comment">// 设置过期时间为当前时间 + 1 小时</span>
            SigningCredentials <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">SigningCredentials</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token constructor-invocation class-name">SymmetricSecurityKey</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">,</span> SecurityAlgorithms<span class="token punctuation">.</span>HmacSha256Signature<span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>

        <span class="token class-name"><span class="token keyword">var</span></span> token <span class="token operator">=</span> tokenHandler<span class="token punctuation">.</span><span class="token function">CreateToken</span><span class="token punctuation">(</span>tokenDescriptor<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name"><span class="token keyword">var</span></span> tokenString <span class="token operator">=</span> tokenHandler<span class="token punctuation">.</span><span class="token function">WriteToken</span><span class="token punctuation">(</span>token<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">return</span> tokenString<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/// &lt;summary&gt;</span>
    <span class="token comment">/// 解密</span>
    <span class="token comment">/// &lt;/summary&gt;</span>
    <span class="token comment">/// &lt;param name=&quot;token&quot;&gt;&lt;/param&gt;</span>
    <span class="token comment">/// &lt;returns&gt;&lt;/returns&gt;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token return-type class-name"><span class="token keyword">bool</span></span> <span class="token function">ValidateToken</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">string</span></span> token<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token class-name"><span class="token keyword">var</span></span> tokenHandler <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">JwtSecurityTokenHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 扩展密钥大小为 128 位（32 字节）</span>
        <span class="token class-name"><span class="token keyword">var</span></span> key <span class="token operator">=</span> Encoding<span class="token punctuation">.</span>ASCII<span class="token punctuation">.</span><span class="token function">GetBytes</span><span class="token punctuation">(</span>secretKey<span class="token punctuation">.</span><span class="token function">PadRight</span><span class="token punctuation">(</span><span class="token number">32</span><span class="token punctuation">,</span> <span class="token char">'\0'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  

        <span class="token keyword">try</span>
        <span class="token punctuation">{</span>
            tokenHandler<span class="token punctuation">.</span><span class="token function">ValidateToken</span><span class="token punctuation">(</span>token<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">TokenValidationParameters</span>
            <span class="token punctuation">{</span>
                IssuerSigningKey <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">SymmetricSecurityKey</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">,</span>
                ValidateIssuerSigningKey <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
                ValidateIssuer <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
                ValidateAudience <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
                ClockSkew <span class="token operator">=</span> TimeSpan<span class="token punctuation">.</span>Zero
            <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token keyword">out</span> <span class="token class-name"><span class="token keyword">var</span></span> validatedToken<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">catch</span>
        <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><div class="language-csharp extra-class"><pre class="language-csharp"><code><span class="token comment">//获取token</span>
TokenHelper<span class="token punctuation">.</span><span class="token function">GenerateToken</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//验证token</span>
TokenHelper<span class="token punctuation">.</span><span class="token function">ValidateToken</span><span class="token punctuation">(</span>token<span class="token punctuation">)</span><span class="token punctuation">;</span>

</code></pre></div><blockquote><p>方式二：使用ASP.NET Core服务注册</p></blockquote> <p><strong>步骤一：创建配置类将SecurityKey和Domain常量进行存储或者放到配置文件中</strong></p> <div class="language-csharp extra-class"><pre class="language-csharp"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">JWTConst</span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">const</span> <span class="token class-name"><span class="token keyword">string</span></span> SecurityKey <span class="token operator">=</span> <span class="token string">&quot;MIGfMA0GCSqGSIb3DQEBAQUAA4GNADCBiQKBgQDSfLGu+kcFDcJUCV46J+SbgR0lNc2NqgCGzojQTWW9xqjuzPF3mpisvTggYZSGfBzN+88YLZYbBLrDTUMJ4nTieElbP6SHkBFu8F+7fFBi7w3UPsaAXDr2E2srQYU5ZlKAcFBoNajNWj3sfSVRoYRPdqDTj4WdJlUPSNGz0wgRrQIDAQAB&quot;</span><span class="token punctuation">;</span>
 	<span class="token comment">//定义范围、域</span>
    <span class="token keyword">public</span> <span class="token keyword">const</span> <span class="token class-name"><span class="token keyword">string</span></span> Domain <span class="token operator">=</span> <span class="token string">&quot;http://localhost:5000&quot;</span><span class="token punctuation">;</span>
 
<span class="token punctuation">}</span>

</code></pre></div><p><strong>步骤二：在startup.cs中添加服务</strong></p> <div class="language-csharp extra-class"><pre class="language-csharp"><code><span class="token comment">//配置jwt服务</span>
services<span class="token punctuation">.</span><span class="token function">AddAuthentication</span><span class="token punctuation">(</span>JwtBearerDefaults<span class="token punctuation">.</span>AuthenticationScheme<span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">AddJwtBearer</span><span class="token punctuation">(</span>options <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        options<span class="token punctuation">.</span>TokenValidationParameters <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">TokenValidationParameters</span>
        <span class="token punctuation">{</span>
            ValidateIssuer <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">,</span><span class="token comment">//是否验证Issuer</span>
            ValidateAudience <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">,</span><span class="token comment">//是否验证Audience</span>
            ValidateLifetime <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">,</span><span class="token comment">//是否验证失效时间</span>
            ClockSkew <span class="token operator">=</span> TimeSpan<span class="token punctuation">.</span><span class="token function">FromSeconds</span><span class="token punctuation">(</span><span class="token number">30</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            ValidateIssuerSigningKey <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">,</span><span class="token comment">//是否验证SecurityKey</span>
            ValidAudience <span class="token operator">=</span> JWTConst<span class="token punctuation">.</span>Domain<span class="token punctuation">,</span><span class="token comment">//Audience</span>
            ValidIssuer <span class="token operator">=</span> JWTConst<span class="token punctuation">.</span>Domain<span class="token punctuation">,</span><span class="token comment">//Issuer，这两项和前面签发jwt的设置一致</span>
            IssuerSigningKey <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">SymmetricSecurityKey</span><span class="token punctuation">(</span>Encoding<span class="token punctuation">.</span>UTF8<span class="token punctuation">.</span><span class="token function">GetBytes</span><span class="token punctuation">(</span>JWTConst<span class="token punctuation">.</span>SecurityKey<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment">//拿到SecurityKey</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">//JWT全局验权配置(每一个接口都需要验权)</span>
builder<span class="token punctuation">.</span>Services<span class="token punctuation">.</span><span class="token function">AddRazorPages</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">AddMvcOptions</span><span class="token punctuation">(</span>option <span class="token operator">=&gt;</span>
<span class="token punctuation">{</span>
    option<span class="token punctuation">.</span>Filters<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token constructor-invocation class-name">AuthorizeFilter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p><strong>步骤三：添加验证中间件</strong></p> <div class="language-csharp extra-class"><pre class="language-csharp"><code>app<span class="token punctuation">.</span><span class="token function">UseAuthentication</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p><strong>步骤四：获取token接口</strong></p> <div class="language-csharp extra-class"><pre class="language-csharp"><code><span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">AllowAnonymous</span></span><span class="token punctuation">]</span><span class="token comment">//指定此属性应用于的类或方法不需要授权验证。</span>
<span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">HttpGet</span></span><span class="token punctuation">]</span>
<span class="token keyword">public</span> <span class="token return-type class-name">IActionResult</span> <span class="token function">Get</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">string</span></span> userName<span class="token punctuation">,</span> <span class="token class-name"><span class="token keyword">string</span></span> pwd<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">string</span><span class="token punctuation">.</span><span class="token function">IsNullOrEmpty</span><span class="token punctuation">(</span>userName<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token keyword">string</span><span class="token punctuation">.</span><span class="token function">IsNullOrEmpty</span><span class="token punctuation">(</span>pwd<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token class-name"><span class="token keyword">var</span></span> claims <span class="token operator">=</span> <span class="token keyword">new</span><span class="token punctuation">[</span><span class="token punctuation">]</span>
        <span class="token punctuation">{</span>
            <span class="token keyword">new</span> <span class="token constructor-invocation class-name">Claim</span><span class="token punctuation">(</span>JwtRegisteredClaimNames<span class="token punctuation">.</span>Nbf<span class="token punctuation">,</span><span class="token interpolation-string"><span class="token string">$&quot;</span><span class="token interpolation"><span class="token punctuation">{</span><span class="token expression language-csharp"><span class="token keyword">new</span> <span class="token constructor-invocation class-name">DateTimeOffset</span><span class="token punctuation">(</span>DateTime<span class="token punctuation">.</span>Now<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ToUnixTimeSeconds</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span><span class="token punctuation">}</span></span><span class="token string">&quot;</span></span><span class="token punctuation">)</span> <span class="token punctuation">,</span>
            <span class="token keyword">new</span> <span class="token constructor-invocation class-name">Claim</span> <span class="token punctuation">(</span>JwtRegisteredClaimNames<span class="token punctuation">.</span>Exp<span class="token punctuation">,</span><span class="token interpolation-string"><span class="token string">$&quot;</span><span class="token interpolation"><span class="token punctuation">{</span><span class="token expression language-csharp"><span class="token keyword">new</span> <span class="token constructor-invocation class-name">DateTimeOffset</span><span class="token punctuation">(</span>DateTime<span class="token punctuation">.</span>Now<span class="token punctuation">.</span><span class="token function">AddMinutes</span><span class="token punctuation">(</span><span class="token number">30</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ToUnixTimeSeconds</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span><span class="token punctuation">}</span></span><span class="token string">&quot;</span></span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token keyword">new</span> <span class="token constructor-invocation class-name">Claim</span><span class="token punctuation">(</span>ClaimTypes<span class="token punctuation">.</span>Name<span class="token punctuation">,</span> userName<span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
        <span class="token class-name"><span class="token keyword">var</span></span> key <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">SymmetricSecurityKey</span><span class="token punctuation">(</span>Encoding<span class="token punctuation">.</span>UTF8<span class="token punctuation">.</span><span class="token function">GetBytes</span><span class="token punctuation">(</span>JWTConst<span class="token punctuation">.</span>SecurityKey<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name"><span class="token keyword">var</span></span> creds <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">SigningCredentials</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> SecurityAlgorithms<span class="token punctuation">.</span>HmacSha256<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name"><span class="token keyword">var</span></span> token <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">JwtSecurityToken</span><span class="token punctuation">(</span>
            <span class="token named-parameter punctuation">issuer</span><span class="token punctuation">:</span> JWTConst<span class="token punctuation">.</span>Domain<span class="token punctuation">,</span>
            <span class="token named-parameter punctuation">audience</span><span class="token punctuation">:</span> JWTConst<span class="token punctuation">.</span>Domain<span class="token punctuation">,</span>
            <span class="token named-parameter punctuation">claims</span><span class="token punctuation">:</span> claims<span class="token punctuation">,</span>
            <span class="token named-parameter punctuation">expires</span><span class="token punctuation">:</span> DateTime<span class="token punctuation">.</span>Now<span class="token punctuation">.</span><span class="token function">AddMinutes</span><span class="token punctuation">(</span><span class="token number">30</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token named-parameter punctuation">signingCredentials</span><span class="token punctuation">:</span> creds<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">return</span> <span class="token function">Ok</span><span class="token punctuation">(</span><span class="token keyword">new</span>
        <span class="token punctuation">{</span>
        	token <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">JwtSecurityTokenHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">WriteToken</span><span class="token punctuation">(</span>token<span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token function">BadRequest</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token punctuation">{</span> message <span class="token operator">=</span> <span class="token string">&quot;username or password is incorrect.&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p><strong>tips：[Authorize]标签表示需要验权，[AllowAnonymous]标签表示不需要授权验证。如果配置了全局验权则不需要使用[Authorize]标签，只需在不需要验权的地方加上[AllowAnonymous]标签</strong></p> <p><strong>用postman测试的时候在授权里面选择Bearer Token进行令牌填写</strong></p> <h1 id="设计模式-六大原则"><a href="#设计模式-六大原则" class="header-anchor">#</a> 设计模式——六大原则</h1> <h2 id="单一职责-single-responsibility-principle"><a href="#单一职责-single-responsibility-principle" class="header-anchor">#</a> <strong>单一职责（Single Responsibility Principle）</strong></h2> <blockquote><p>一个类只负责一个功能领域中的相应职责</p></blockquote> <p><strong>优点：</strong></p> <ul><li>可以降低类的复杂度；</li> <li>提高类的可读性；</li> <li>提高系统的可维护性；</li> <li>变更引起的风险降低。</li></ul> <h2 id="开闭原则-open-closed-principle"><a href="#开闭原则-open-closed-principle" class="header-anchor">#</a> <strong>开闭原则（open closed principle）</strong></h2> <blockquote><p>一个软件实体应当对扩展开放，对修改关闭。即软件实体应尽量在不修改原有代码的情况下进行扩展。</p></blockquote> <p>优点：</p> <ul><li>降低耦合性；</li> <li>提高复用性；</li> <li>提高可扩展性；</li> <li>减少代码冗余；</li> <li>提高可读性；</li> <li>提高可维护性；</li> <li>降低风险。</li></ul> <h2 id="里氏替换"><a href="#里氏替换" class="header-anchor">#</a> 里氏替换</h2> <blockquote><p><strong>子类可以扩展父类的功能，但不能改变父类原有的功能。</strong> （子类可以继承父类，但是不能覆盖父类的非抽象方法）</p> <p>里氏代换原则是<a href="https://so.csdn.net/so/search?q=%E5%BC%80%E9%97%AD%E5%8E%9F%E5%88%99&amp;spm=1001.2101.3001.7020" target="_blank" rel="noopener noreferrer">开闭原则<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>的重要方式之一，由于使用父类对象的地方都可以使用子类对象，因此在程序中尽量使用父类类型来对对象进行定义，而在运行时再确定其子类类型，用子类对象来替换父类对象。</p></blockquote> <p><strong>总结</strong></p> <p>不要覆盖父类中的方法，如果要改写，则在父类中编写虚方法（virtual），子类重写虚方法（override）。或者在父类中定义抽象方法（abstract），子类进行实现（override）</p> <p><strong>里氏替换原则的优点</strong></p> <ol><li>代码共享，减少创建类的工作量，每个子类都拥有父类的方法和属性；</li> <li>提高代码的重用性；</li> <li>子类可以形似父类，但又异于父类。</li> <li>提高代码的可扩展性。</li> <li>提高产品或项目的开放性。</li></ol> <p><strong>里氏替换原则的缺点</strong></p> <ol><li>继承是侵入性的。只要继承，就必须拥有父类的所有属性和方法；</li> <li>降低代码的灵活性。子类必须拥有父类的属性和方法。</li> <li>增强了耦合性。当父类的常量、变量和方法被修改时，需要考虑子类的修改，可能导致大段的代码需要重构。</li></ol> <h2 id="迪米特法则"><a href="#迪米特法则" class="header-anchor">#</a> 迪米特法则</h2> <p><strong>迪米特法则</strong>又叫做最少知道原则，就是说一个对象应当对其它对象有尽可能少的了解，不要和陌生人说话。</p> <p>一个类对自己需要耦合或调用的类知道得最少，你（调用的类的）的内部是多么复杂都和我没有关系，那是你的事情，我只关心你提供的public方法，你提供我就调用，其他一概不关心。</p> <p>强调只和朋友说话，不和陌生人说话。这里的朋友指的是:出现在成员中<strong>变量</strong>，<strong>方法输入</strong>，<strong>输出参数</strong>中的类称为成员朋友类，而出现在方法体内部的类不属于朋友类。</p> <p>从迪米特法则的定义和特点可知，它强调以下两点：</p> <ol><li><p>从依赖者的角度来说，只依赖应该依赖的对象。</p></li> <li><p>从被依赖者的角度说，只暴露应该暴露的方法。</p></li></ol> <p><strong>示例：订披萨</strong></p> <p>违反示例</p> <p><code>PizzaStore.cs</code></p> <div class="language-csharp extra-class"><pre class="language-csharp"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">PizzaStore</span> <span class="token punctuation">{</span>
 
    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">takeOrder</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        System<span class="token punctuation">.</span><span class="token keyword">out</span><span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;披萨店接收订单&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
 
    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">prepareSource</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        System<span class="token punctuation">.</span><span class="token keyword">out</span><span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;披萨店准备披萨制作原料&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
 
    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">cookPizza</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        System<span class="token punctuation">.</span><span class="token keyword">out</span><span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;披萨店烹制披萨&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
 
    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">packPizza</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        System<span class="token punctuation">.</span><span class="token keyword">out</span><span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;披萨店打包披萨&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
 
    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">deliveryPizza</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        System<span class="token punctuation">.</span><span class="token keyword">out</span><span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;披萨店配送披萨&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre></div><p><code>Customer.cs</code></p> <div class="language-csharp extra-class"><pre class="language-csharp"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Customer</span> <span class="token punctuation">{</span>
 
    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">orderPizza</span><span class="token punctuation">(</span><span class="token class-name">PizzaStore</span> pizzaStore<span class="token punctuation">)</span><span class="token punctuation">{</span>
        pizzaStore<span class="token punctuation">.</span><span class="token function">takeOrder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        pizzaStore<span class="token punctuation">.</span><span class="token function">prepareSource</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        pizzaStore<span class="token punctuation">.</span><span class="token function">cookPizza</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        pizzaStore<span class="token punctuation">.</span><span class="token function">packPizza</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        pizzaStore<span class="token punctuation">.</span><span class="token function">deliveryPizza</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre></div><p><code>main</code></p> <div class="language-csharp extra-class"><pre class="language-csharp"><code><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String<span class="token punctuation">[</span><span class="token punctuation">]</span></span> args<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token class-name">Customer</span> xiaoming <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">Customer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">PizzaStore</span> pizzaStore <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">PizzaStore</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    xiaoming<span class="token punctuation">.</span><span class="token function">orderPizza</span><span class="token punctuation">(</span>pizzaStore<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre></div><p>改正示例</p> <p><code>PizzaStore.cs</code></p> <div class="language-csharp extra-class"><pre class="language-csharp"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">PizzaStore</span> <span class="token punctuation">{</span>
 
    <span class="token keyword">private</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">takeOrder</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        System<span class="token punctuation">.</span><span class="token keyword">out</span><span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;披萨店接收订单&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
 
    <span class="token keyword">private</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">prepareSource</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        System<span class="token punctuation">.</span><span class="token keyword">out</span><span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;披萨店准备披萨制作原料&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
 
    <span class="token keyword">private</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">cookPizza</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        System<span class="token punctuation">.</span><span class="token keyword">out</span><span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;披萨店烹制披萨&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
 
    <span class="token keyword">private</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">packPizza</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        System<span class="token punctuation">.</span><span class="token keyword">out</span><span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;披萨店打包披萨&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
 
    <span class="token keyword">private</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">deliveryPizza</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        System<span class="token punctuation">.</span><span class="token keyword">out</span><span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;披萨店配送披萨&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
 
    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">orderPizza</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">takeOrder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">prepareSource</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">cookPizza</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">packPizza</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">deliveryPizza</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p><code>Customer.cs</code></p> <div class="language-csharp extra-class"><pre class="language-csharp"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Customer</span> <span class="token punctuation">{</span>
 
    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">orderPizza</span><span class="token punctuation">(</span><span class="token class-name">PizzaStore</span> pizzaStore<span class="token punctuation">)</span><span class="token punctuation">{</span>
        pizzaStore<span class="token punctuation">.</span><span class="token function">orderPizza</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p><code>main</code></p> <div class="language-csharp extra-class"><pre class="language-csharp"><code><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String<span class="token punctuation">[</span><span class="token punctuation">]</span></span> args<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token class-name">Customer</span> xiaoming <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">Customer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">PizzaStore</span> pizzaStore <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">PizzaStore</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    xiaoming<span class="token punctuation">.</span><span class="token function">orderPizza</span><span class="token punctuation">(</span>pizzaStore<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre></div><p>这样改之后，客户和披萨店之间的沟通只有orderPizza()方法了，其他的方法客户根本访问不了，因为其他方法都是private属性。这样极大的减少了二者之间的沟通，这就是迪米特法则所要求的<strong>尽量减少两个实体之间的交互</strong>。</p> <h2 id="接口隔离"><a href="#接口隔离" class="header-anchor">#</a> 接口隔离</h2> <p><strong>原则定义</strong></p> <p>接口隔离原则要求程序员尽量将臃肿庞大的接口拆分成更小的和更具体的接口，让接口中只包含客户感兴趣的方法。</p> <p>客户端不应该被迫依赖于它不使用的方法。该原则还有另外一个定义：一个类对另一个类的依赖应该建立在最小的接口上。</p> <p>要为各个类建立它们需要的专用接口，而不要试图去建立一个很庞大的接口供所有依赖它的类去调用。</p> <p><strong>实现原理</strong></p> <p>在具体应用接口隔离原则时，应该根据以下几个规则来衡量。</p> <ol><li>接口尽量小，但是要有限度。一个接口只服务于一个子模块或业务逻辑。</li> <li>为依赖接口的类定制服务。只提供调用者需要的方法，屏蔽不需要的方法。</li> <li>了解环境，拒绝盲从。每个项目或产品都有选定的环境因素，环境不同，接口拆分的标准就不同深入了解业务逻辑。</li> <li>提高内聚，减少对外交互。使接口用最少的方法去完成最多的事情。</li></ol> <h2 id="依赖倒置dependence-inversion-principle"><a href="#依赖倒置dependence-inversion-principle" class="header-anchor">#</a> 依赖倒置Dependence Inversion Principle</h2> <p><strong>原则定义</strong></p> <ul><li><p>高层模块不应该依赖低层模块，两者都应该依赖其抽象</p> <p>​                                         UI层不可以实例化Service</p></li> <li><p>抽象不应该依赖细节      接口不能继承类</p></li> <li><p>细节应该依赖抽象          类要继承接口</p></li></ul> <p>例子：司机开车</p> <p><code>ICar.cs</code></p> <div class="language-csharp extra-class"><pre class="language-csharp"><code><span class="token keyword">internal</span> <span class="token keyword">interface</span> <span class="token class-name">ICar</span>
<span class="token punctuation">{</span>
    <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre></div><p><code>IDriver.cs</code></p> <div class="language-csharp extra-class"><pre class="language-csharp"><code><span class="token keyword">internal</span> <span class="token keyword">interface</span> <span class="token class-name">IDriver</span>
<span class="token punctuation">{</span>
    <span class="token comment">//司机开车抽象方法</span>
    <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">driver</span><span class="token punctuation">(</span><span class="token class-name">ICar</span> car<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre></div><p><code>Benz.cs</code></p> <div class="language-csharp extra-class"><pre class="language-csharp"><code><span class="token keyword">internal</span> <span class="token keyword">class</span> <span class="token class-name">Benz</span><span class="token punctuation">:</span><span class="token type-list"><span class="token class-name">ICar</span></span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token string">&quot;奔驰车开动&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre></div><p><code>BMW.cs</code></p> <div class="language-csharp extra-class"><pre class="language-csharp"><code><span class="token comment">//细节依赖于抽象</span>
<span class="token keyword">internal</span> <span class="token keyword">class</span> <span class="token class-name">BMW</span><span class="token punctuation">:</span><span class="token type-list"><span class="token class-name">ICar</span></span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token string">&quot;宝马车开动&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre></div><p><code>main</code></p> <div class="language-csharp extra-class"><pre class="language-csharp"><code><span class="token comment">//准备一个奔驰车</span>
<span class="token class-name">Benz</span> a100 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">Benz</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">BMW</span> x1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">BMW</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//通过接口创建一个类对象</span>
<span class="token class-name">IDriver</span> xiaowang <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">Driver</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
xiaowang<span class="token punctuation">.</span><span class="token function">driver</span><span class="token punctuation">(</span>a100<span class="token punctuation">)</span><span class="token punctuation">;</span>

</code></pre></div><p>在新增低层模块时，只修改了高层模块(业务场景类)，对其他低层模块(Driver类)不需要做任何修改，可以把&quot;变更&quot;的风险降低到最低。</p> <p>总结：所谓的依赖倒置中的倒置，指的是原本司机开什么车是由司机决定的，但是现在是由接口接收的注入对象决定的。</p> <h1 id="git"><a href="#git" class="header-anchor">#</a> GIT</h1> <blockquote><p>源代码管理仓库</p></blockquote> <p>常用命令</p> <blockquote><p>git clone 克隆链接：将线上项目克隆下来</p></blockquote> <h1 id="一些更加方便的写法"><a href="#一些更加方便的写法" class="header-anchor">#</a> 一些更加方便的写法</h1> <blockquote><p>ForEach（Action）</p></blockquote> <div class="language-csharp extra-class"><pre class="language-csharp"><code>List<span class="token punctuation">.</span><span class="token function">ForEach</span><span class="token punctuation">(</span>x<span class="token operator">=&gt;</span>x<span class="token punctuation">.</span>name<span class="token operator">=</span>'admin'<span class="token punctuation">)</span><span class="token punctuation">;</span>

List<span class="token punctuation">.</span><span class="token function">ForEach</span><span class="token punctuation">(</span>x<span class="token operator">=&gt;</span><span class="token punctuation">{</span>
    x<span class="token punctuation">.</span>name<span class="token operator">=</span>'admin'<span class="token punctuation">;</span>
    x<span class="token operator">=&gt;</span>x<span class="token punctuation">.</span>age<span class="token operator">=</span><span class="token number">18</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
List<span class="token punctuation">.</span><span class="token function">ForEach</span><span class="token punctuation">(</span>x<span class="token operator">=&gt;</span><span class="token punctuation">{</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>x<span class="token punctuation">.</span>age<span class="token operator">&gt;</span><span class="token number">18</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        x<span class="token punctuation">.</span>istrue<span class="token operator">=</span><span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

</code></pre></div><h1 id="datetime"><a href="#datetime" class="header-anchor">#</a> DateTime</h1> <div class="language-csharp extra-class"><pre class="language-csharp"><code>DateTime<span class="token punctuation">.</span>Now<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token string">&quot;yyMMdd HHmmss&quot;</span><span class="token punctuation">)</span> <span class="token comment">//以指定形式格式化时间</span>

</code></pre></div><h1 id="支付宝支付"><a href="#支付宝支付" class="header-anchor">#</a> 支付宝支付</h1> <h2 id="公共响应参数"><a href="#公共响应参数" class="header-anchor">#</a> 公共响应参数</h2> <table><thead><tr><th style="text-align:left;">参数</th> <th style="text-align:left;">类型</th> <th style="text-align:left;">是否必选</th> <th style="text-align:left;">最大长度</th> <th style="text-align:left;">描述</th> <th style="text-align:left;">示例值</th></tr></thead> <tbody><tr><td style="text-align:left;">code</td> <td style="text-align:left;">String</td> <td style="text-align:left;">必选</td> <td style="text-align:left;">-</td> <td style="text-align:left;">网关返回码,<a href="https://opendoc.alipay.com/common/02km9f" target="_blank" rel="noopener noreferrer">详见文档<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></td> <td style="text-align:left;">40004</td></tr> <tr><td style="text-align:left;">msg</td> <td style="text-align:left;">String</td> <td style="text-align:left;">必选</td> <td style="text-align:left;">-</td> <td style="text-align:left;">网关返回码描述,<a href="https://opendoc.alipay.com/common/02km9f" target="_blank" rel="noopener noreferrer">详见文档<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></td> <td style="text-align:left;">Business Failed</td></tr> <tr><td style="text-align:left;">sub_code</td> <td style="text-align:left;">String</td> <td style="text-align:left;">可选</td> <td style="text-align:left;">-</td> <td style="text-align:left;">业务返回码，参见具体的API接口文档</td> <td style="text-align:left;">ACQ.TRADE_HAS_SUCCESS</td></tr> <tr><td style="text-align:left;">sub_msg</td> <td style="text-align:left;">String</td> <td style="text-align:left;">可选</td> <td style="text-align:left;">-</td> <td style="text-align:left;">业务返回码描述，参见具体的API接口文档</td> <td style="text-align:left;">交易已被支付</td></tr> <tr><td style="text-align:left;">sign</td> <td style="text-align:left;">String</td> <td style="text-align:left;">必选</td> <td style="text-align:left;">-</td> <td style="text-align:left;">签名,<a href="https://opendoc.alipay.com/common/02kf5q" target="_blank" rel="noopener noreferrer">详见文档<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></td> <td style="text-align:left;">DZXh8eeTuAHoYE3w1J+POiPhfDxOYBfUNn1lkeT/V7P4zJdyojWEa6IZs6Hz0yDW5Cp/viufUb5I0/V5WENS3OYR8zRedqo6D+fUTdLHdc+EFyCkiQhBxIzgngPdPdfp1PIS7BdhhzrsZHbRqb7o4k3Dxc+AAnFauu4V6Zdwczo=</td></tr></tbody></table> <h1 id="发送qq邮箱"><a href="#发送qq邮箱" class="header-anchor">#</a> 发送QQ邮箱</h1> <blockquote><p>获取授权码</p></blockquote> <p>进入QQ邮箱主页，点击左上角设置==》账户==》在SMTP服务点击开启服务获取到授权码</p> <div class="language-csharp extra-class"><pre class="language-csharp"><code><span class="token keyword">using</span> <span class="token namespace">System<span class="token punctuation">.</span>Net<span class="token punctuation">.</span>Mail</span><span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token namespace">System<span class="token punctuation">.</span>Net</span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token return-type class-name">JsonResult</span> <span class="token function">sendEmail</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token class-name">MailMessage</span> message <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">MailMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//收件人地址</span>
    message<span class="token punctuation">.</span>To<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span><span class="token string">&quot;3208446980@qq.com&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//发件人地址 不用加，加了自己也会收到一份信息</span>
    <span class="token comment">//message.CC.Add(&quot;1357265300@qq.com&quot;);</span>
    <span class="token comment">//发件人邮箱，名称</span>
    message<span class="token punctuation">.</span>From <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">MailAddress</span><span class="token punctuation">(</span><span class="token string">&quot;1357265300@qq.com&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;admin&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//邮件标题和内容</span>
    message<span class="token punctuation">.</span>Subject <span class="token operator">=</span> <span class="token string">&quot;库存低于阈值&quot;</span><span class="token punctuation">;</span>
    message<span class="token punctuation">.</span>SubjectEncoding <span class="token operator">=</span> System<span class="token punctuation">.</span>Text<span class="token punctuation">.</span>Encoding<span class="token punctuation">.</span>UTF8<span class="token punctuation">;</span><span class="token comment">//格式为utf-8</span>
    message<span class="token punctuation">.</span>Body <span class="token operator">=</span> <span class="token string">&quot;你有库存低于阈值&quot;</span><span class="token punctuation">;</span>
    message<span class="token punctuation">.</span>BodyEncoding <span class="token operator">=</span> System<span class="token punctuation">.</span>Text<span class="token punctuation">.</span>Encoding<span class="token punctuation">.</span>UTF8<span class="token punctuation">;</span><span class="token comment">//格式为utf-8</span>

    <span class="token comment">//                                    SMTP服务器地址   （SMTP端口）qq邮箱587</span>
    <span class="token class-name">SmtpClient</span> smtpClient <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">SmtpClient</span><span class="token punctuation">(</span><span class="token string">&quot;smtp.qq.com&quot;</span><span class="token punctuation">,</span> <span class="token number">587</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    smtpClient<span class="token punctuation">.</span>UseDefaultCredentials <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token comment">//启用SSL加密</span>
    smtpClient<span class="token punctuation">.</span>EnableSsl <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token comment">//发件人邮箱账号，授权码</span>
    smtpClient<span class="token punctuation">.</span>Credentials <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">NetworkCredential</span><span class="token punctuation">(</span><span class="token string">&quot;1357265300@qq.com&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;rdoxtruusumphgef&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">try</span>
    <span class="token punctuation">{</span>
        <span class="token comment">//发送邮件</span>
        smtpClient<span class="token punctuation">.</span><span class="token function">Send</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token function">Json</span><span class="token punctuation">(</span><span class="token string">&quot;true&quot;</span><span class="token punctuation">,</span>JsonRequestBehavior<span class="token punctuation">.</span>AllowGet<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">catch</span><span class="token punctuation">(</span><span class="token class-name">Exception</span> ex<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token function">Json</span><span class="token punctuation">(</span><span class="token string">&quot;error:&quot;</span> <span class="token operator">+</span> ex<span class="token punctuation">.</span>Message<span class="token punctuation">,</span> JsonRequestBehavior<span class="token punctuation">.</span>AllowGet<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><blockquote><p>UseDefaultCredentials：是否使用当前已登录用户的 Windows 凭据来进行身份验证。如果将此属性设置为true，则SMTP客户端将使用当前已登录用户的 Windows 凭据来进行身份验证，而无需在代码中指定用户名和密码。</p></blockquote> <h1 id="定时调度"><a href="#定时调度" class="header-anchor">#</a> 定时调度</h1> <blockquote><p>Quartz.NET： 一个最简单任务至少包括三部分实现：job(作业),trigger（触发器）以及scheduler(调度器)。其中job 是你需要在一个定时任务中具体执行的业务逻辑，trigger则规定job何时并按照何种规则执行，最终job和trigger会被注册到 scheduler(调度器)中，scheduler负责协调job和trigger的运行。</p></blockquote> <blockquote><p>简单使用</p></blockquote> <div class="language-csharp extra-class"><pre class="language-csharp"><code><span class="token keyword">public</span> <span class="token keyword">async</span> <span class="token return-type class-name">Task</span> <span class="token function">AutoTimer</span><span class="token punctuation">(</span><span class="token class-name">IContainer</span> container<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token comment">//创建任务调度器</span>
    <span class="token class-name">ISchedulerFactory</span> schedulerFactory <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">StdSchedulerFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">IScheduler</span> scheduler <span class="token operator">=</span> <span class="token keyword">await</span> schedulerFactory<span class="token punctuation">.</span><span class="token function">GetScheduler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//使用autofacJobFactory代替默认的JobFactory，并传入autofac容器实例(如果在任务中需要进行依赖注入则需要配置)</span>
    scheduler<span class="token punctuation">.</span>JobFactory <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">AutoFacJobFactory</span><span class="token punctuation">(</span>container<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//创建一个作业</span>
    <span class="token class-name">IJobDetail</span> job <span class="token operator">=</span> JobBuilder<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">Create</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>SendSalary<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">WithIdentity</span><span class="token punctuation">(</span><span class="token string">&quot;myjob&quot;</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">Build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//创建一个触发器</span>
    <span class="token class-name">ITrigger</span> trigger <span class="token operator">=</span> TriggerBuilder<span class="token punctuation">.</span><span class="token function">Create</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">WithIdentity</span><span class="token punctuation">(</span><span class="token string">&quot;myjob&quot;</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">StartNow</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token comment">//现在开始</span>
        <span class="token punctuation">.</span><span class="token function">WithSimpleSchedule</span><span class="token punctuation">(</span>x <span class="token operator">=&gt;</span> x<span class="token punctuation">.</span><span class="token function">WithIntervalInSeconds</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">RepeatForever</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment">//10s执行一次,无限循环执行</span>
        <span class="token comment">//.WithCronSchedule(&quot;0 0 10 1 * ? &quot;)  //每个月的1号上午10点触发</span>
        <span class="token punctuation">.</span><span class="token function">Build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//将作业，触发器加入调度器</span>
    <span class="token keyword">await</span> scheduler<span class="token punctuation">.</span><span class="token function">ScheduleJob</span><span class="token punctuation">(</span>job<span class="token punctuation">,</span> trigger<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//启动</span>
    <span class="token keyword">await</span> scheduler<span class="token punctuation">.</span><span class="token function">Start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p><code>QuartzJob.cs</code></p> <div class="language-csharp extra-class"><pre class="language-csharp"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">QuartzJob</span>
<span class="token punctuation">{</span>
    <span class="token comment">//定时发放薪水</span>
    <span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SendSalary</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">IJob</span></span>
    <span class="token punctuation">{</span>
        <span class="token comment">//依赖注入，注意:在Job中使用DI得在Global中进行注册替换</span>
        <span class="token keyword">private</span> <span class="token keyword">readonly</span> <span class="token class-name">IStaffService</span> _staffService<span class="token punctuation">;</span>
        
        <span class="token keyword">public</span> <span class="token function">SendSalary</span><span class="token punctuation">(</span><span class="token class-name">IStaffService</span> staffService<span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
			_staffService <span class="token operator">=</span> staffService<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">public</span> <span class="token keyword">async</span> <span class="token return-type class-name">Task</span> <span class="token function">Execute</span><span class="token punctuation">(</span><span class="token class-name">IJobExecutionContext</span> context<span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token class-name"><span class="token keyword">var</span></span> description <span class="token operator">=</span> context<span class="token punctuation">.</span>JobDetail<span class="token punctuation">.</span>Description<span class="token punctuation">;</span>
            <span class="token class-name"><span class="token keyword">var</span></span> identity <span class="token operator">=</span> context<span class="token punctuation">.</span>JobDetail<span class="token punctuation">.</span>Key<span class="token punctuation">.</span>Name<span class="token punctuation">;</span>
            <span class="token comment">//需要执行的任务逻辑</span>
            System<span class="token punctuation">.</span>IO<span class="token punctuation">.</span>File<span class="token punctuation">.</span><span class="token function">AppendAllText</span><span class="token punctuation">(</span><span class="token string">@&quot;C:\A\a.txt&quot;</span><span class="token punctuation">,</span> DateTime<span class="token punctuation">.</span>Now<span class="token punctuation">.</span><span class="token function">ToString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p><strong>使用DI需要的配置方法</strong></p> <p><code>AutoFacJobFactory.cs</code></p> <div class="language-csharp extra-class"><pre class="language-csharp"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AutoFacJobFactory</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">IJobFactory</span></span>
<span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token keyword">readonly</span> <span class="token class-name">IContainer</span> _container<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token function">AutoFacJobFactory</span><span class="token punctuation">(</span><span class="token class-name">IContainer</span> container<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        _container <span class="token operator">=</span> container<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token return-type class-name">IJob</span> <span class="token function">NewJob</span><span class="token punctuation">(</span><span class="token class-name">TriggerFiredBundle</span> bundle<span class="token punctuation">,</span> <span class="token class-name">IScheduler</span> scheduler<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token punctuation">(</span>IJob<span class="token punctuation">)</span>_container<span class="token punctuation">.</span><span class="token function">Resolve</span><span class="token punctuation">(</span>bundle<span class="token punctuation">.</span>JobDetail<span class="token punctuation">.</span>JobType<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">ReturnJob</span><span class="token punctuation">(</span><span class="token class-name">IJob</span> job<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>

    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p><code>Global.asax.cs</code></p> <div class="language-csharp extra-class"><pre class="language-csharp"><code><span class="token keyword">protected</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">Application_Start</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    AreaRegistration<span class="token punctuation">.</span><span class="token function">RegisterAllAreas</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    RouteConfig<span class="token punctuation">.</span><span class="token function">RegisterRoutes</span><span class="token punctuation">(</span>RouteTable<span class="token punctuation">.</span>Routes<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token range operator">..</span><span class="token punctuation">.</span>
    <span class="token comment">//配置autofac容器</span>
    <span class="token class-name">IContainer</span> container <span class="token operator">=</span> <span class="token function">AutofacRegister</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//定时调度</span>
    <span class="token function">AutoTimer</span><span class="token punctuation">(</span>container<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">//注册容器</span>
<span class="token keyword">private</span> <span class="token return-type class-name">IContainer</span> <span class="token function">AutofacRegister</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token range operator">..</span><span class="token punctuation">.</span>
    <span class="token comment">//注册工作</span>
    builder<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">RegisterType</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>SendSalary<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">AsSelf</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">InstancePerDependency</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//薪资发放工作</span>
	<span class="token range operator">..</span><span class="token punctuation">.</span>
    <span class="token keyword">return</span> container<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">//定时调度</span>
<span class="token keyword">public</span> <span class="token keyword">async</span> <span class="token return-type class-name">Task</span> <span class="token function">AutoTimer</span><span class="token punctuation">(</span><span class="token class-name">IContainer</span> container<span class="token punctuation">)</span>
<span class="token punctuation">{</span>

    <span class="token comment">//创建任务调度器</span>
    <span class="token class-name">ISchedulerFactory</span> schedulerFactory <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">StdSchedulerFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">IScheduler</span> scheduler <span class="token operator">=</span> <span class="token keyword">await</span> schedulerFactory<span class="token punctuation">.</span><span class="token function">GetScheduler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//使用autofacJobFactory代替默认的JobFactory，并传入autofac容器实例</span>
    scheduler<span class="token punctuation">.</span>JobFactory <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">AutoFacJobFactory</span><span class="token punctuation">(</span>container<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//创建一个作业</span>
    <span class="token class-name">IJobDetail</span> job <span class="token operator">=</span> JobBuilder<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">Create</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>SendSalary<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">WithIdentity</span><span class="token punctuation">(</span><span class="token string">&quot;myjob&quot;</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">Build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//创建一个触发器</span>
    <span class="token class-name">ITrigger</span> trigger <span class="token operator">=</span> TriggerBuilder<span class="token punctuation">.</span><span class="token function">Create</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">WithIdentity</span><span class="token punctuation">(</span><span class="token string">&quot;myjob&quot;</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">StartNow</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token comment">//现在开始</span>
        <span class="token punctuation">.</span><span class="token function">WithSimpleSchedule</span><span class="token punctuation">(</span>x <span class="token operator">=&gt;</span> x<span class="token punctuation">.</span><span class="token function">WithIntervalInSeconds</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">RepeatForever</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment">//10s执行一次,无限循环执行</span>
        <span class="token comment">//.WithCronSchedule(&quot;0 0 10 1 * ? &quot;)  //每个月的1号上午10点触发</span>
        <span class="token punctuation">.</span><span class="token function">Build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//将作业，触发器加入调度器</span>
    <span class="token keyword">await</span> scheduler<span class="token punctuation">.</span><span class="token function">ScheduleJob</span><span class="token punctuation">(</span>job<span class="token punctuation">,</span> trigger<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//启动</span>
    <span class="token keyword">await</span> scheduler<span class="token punctuation">.</span><span class="token function">Start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p><strong>tips</strong></p> <ol><li>格式: [秒] [分] [小时] [日] [月] [周] [年]</li></ol> <table><thead><tr><th>说明</th> <th>是否必填</th> <th>允许填写的值</th> <th>允许的通配符</th> <th></th></tr></thead> <tbody><tr><td>1</td> <td>秒</td> <td>是</td> <td>0-59</td> <td>, - * /</td></tr> <tr><td>2</td> <td>分</td> <td>是</td> <td>0-59</td> <td>, - * /</td></tr> <tr><td>3</td> <td>小时</td> <td>是</td> <td>0-23</td> <td>, - * /</td></tr> <tr><td>4</td> <td>日</td> <td>是</td> <td>1-31</td> <td>, - * ? / L W</td></tr> <tr><td>5</td> <td>月</td> <td>是</td> <td>1-12 or JAN-DEC</td> <td>, - * /</td></tr> <tr><td>6</td> <td>周</td> <td>是</td> <td>1-7 or SUN-SAT</td> <td>, - * ? / L #</td></tr> <tr><td>7</td> <td>年</td> <td>否</td> <td>empty 或 1970-2099</td> <td>, - * /</td></tr></tbody></table> <p><strong>常用示例:</strong></p> <p>格式: [秒] [分] [小时] [日] [月] [周] [年]</p> <p>0 0 12 * * ?      每天12点触发
0 15 10 ? * *     每天10点15分触发
0 15 10 * * ?     每天10点15分触发
0 15 10 * * ? *    每天10点15分触发
0 15 10 * * ? 2005   2005年每天10点15分触发
0 * 14 * * ?      每天下午的 2点到2点59分每分触发
0 0/5 14 * * ?     每天下午的 2点到2点59分(整点开始，每隔5分触发)
0 0/5 14,18 * * ?    每天下午的 18点到18点59分(整点开始，每隔5分触发)</p> <p>0 0-5 14 * * ?      每天下午的 2点到2点05分每分触发
0 10,44 14 ? 3 WED     3月分每周三下午的 2点10分和2点44分触发
0 15 10 ? * MON-FRI    从周一到周五每天上午的10点15分触发
0 15 10 15 * ?       每月15号上午10点15分触发
0 15 10 L * ?       每月最后一天的10点15分触发
0 15 10 ? * 6L      每月最后一周的星期五的10点15分触发
0 15 10 ? * 6L 2002-2005 从2002年到2005年每月最后一周的星期五的10点15分触发</p> <p>0 15 10 ? * 6#3      每月的第三周的星期五开始触发
0 0 12 1/5 * ?      每月的第一个中午开始每隔5天触发一次
0 11 11 11 11 ?      每年的11月11号 11点11分触发(光棍节)</p> <h1 id="mongodb设置局域网可连接"><a href="#mongodb设置局域网可连接" class="header-anchor">#</a> MongoDB设置局域网可连接</h1> <blockquote><p>一、管理员运行cmd命令行进入MongoDB的bin文件夹</p></blockquote> <blockquote><p>二、执行<code>mongod --remove</code>关闭MongoDB服务</p></blockquote> <blockquote><p>三、修改bin文件夹中的mongod.cfg文件中的bindIp为0.0.0.0</p></blockquote> <blockquote><p>四、命令行中执行<code>mongod --config D:\mongoDB\bin\mongod.cfg --logpath D:\mongoDB\log\mongod.log --logappend --dbpath D:\mongoDB\data --serviceName MongoDB --install</code> 安装mongoDB服务</p> <p><strong>如果报错路径不对，把log文件夹中的mongod.log删除了重新执行</strong></p></blockquote> <blockquote><p>五、命令行中执行<code>net start MongoDB</code>启动mongoDB服务</p></blockquote></div> <footer class="page-edit"><!----> <!----></footer> <!----> </main></div><div class="global-ui"></div></div>
    <script src="/blog/assets/js/app.65a534cf.js" defer></script><script src="/blog/assets/js/2.9b17f659.js" defer></script><script src="/blog/assets/js/11.21536efd.js" defer></script>
  </body>
</html>
